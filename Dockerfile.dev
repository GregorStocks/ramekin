FROM rust:latest

# Install dependencies
RUN apt-get update && apt-get install -y \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for hot reload and diesel-cli for migrations
RUN cargo install cargo-watch && \
    cargo install diesel_cli --no-default-features --features postgres

WORKDIR /app

# Create target directories with world-writable permissions for non-root users
RUN mkdir -p /app/server/target /app/cli/target && chmod -R 777 /app

# The source will be mounted as a volume
# No need to copy or build here - cargo-watch will handle it

EXPOSE 3000

# Default command (can be overridden)
CMD ["cargo", "watch", "-x", "run --package ramekin-server"]
