---
name: iOS

"on":
  pull_request:
    branches: ["*"]
    paths:
      - 'ramekin-ios/**'
      - '.github/workflows/ios.yml'

jobs:
  ios:
    name: iOS Tests
    runs-on: macos-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: make ios-generate

      - name: Find available simulator
        id: simulator
        run: |
          SIMULATOR=$(xcrun simctl list devices available -j | python3 scripts/find-ios-simulator.py)
          echo "Found simulator: $SIMULATOR"
          echo "name=$SIMULATOR" >> $GITHUB_OUTPUT

      - name: Build and test
        run: |
          cd ramekin-ios
          xcodebuild test \
            -scheme Ramekin \
            -destination 'platform=iOS Simulator,name=${{ steps.simulator.outputs.name }}' \
            -skip-testing:RamekinUITests \
            -resultBundlePath TestResults \
            CODE_SIGNING_ALLOWED=NO
