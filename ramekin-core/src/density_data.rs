//! Ingredient density data for volume-to-weight conversion.
//!
//! Densities are stored as grams per US cup (236.588 ml).
//! Data sourced from USDA FoodData Central (public domain, CC0).
//! Generated by scripts/usda-import/import_usda.py

use std::collections::HashMap;
use std::sync::LazyLock;

/// Volume conversion factors to cups (the reference unit for density data).
pub const CUPS_PER_TBSP: f64 = 1.0 / 16.0;
pub const CUPS_PER_TSP: f64 = 1.0 / 48.0;
pub const CUPS_PER_FL_OZ: f64 = 1.0 / 8.0;
pub const CUPS_PER_PINT: f64 = 2.0;
pub const CUPS_PER_QUART: f64 = 4.0;
pub const CUPS_PER_GALLON: f64 = 16.0;
pub const CUPS_PER_ML: f64 = 1.0 / 236.588;
pub const CUPS_PER_L: f64 = 1000.0 / 236.588;

/// Ingredient density data: canonical name -> grams per cup.
pub static DENSITY_DATA: LazyLock<HashMap<&'static str, f64>> = LazyLock::new(|| {
    let mut m = HashMap::new();

    m.insert("all-purpose flour", 125.0);
    m.insert("almond flour", 96.0);
    m.insert(
        "beans, snap, green, canned, regular pack, drained solids",
        129.0,
    );
    m.insert("bread flour", 127.0);
    m.insert("broccoli, raw", 76.0);
    m.insert("brown sugar", 220.0);
    m.insert("butter", 227.0);
    m.insert("cake flour", 114.0);
    m.insert("cheese, cheddar", 105.0);
    m.insert("cheese, cottage, lowfat, 2% milkfat", 220.0);
    m.insert("cheese, dry white, queso seco", 97.3);
    m.insert("cheese, mozzarella, low moisture, part-skim", 86.2);
    m.insert("cheese, parmesan, grated", 121.6);
    m.insert("cheese, ricotta, whole milk", 279.7);
    m.insert("cocoa powder", 86.0);
    m.insert("coconut flour", 112.0);
    m.insert("coconut oil", 218.0);
    m.insert("cornstarch", 128.0);
    m.insert("cream cheese", 232.0);
    m.insert("dried egg yolk (without free-flow agent added)", 67.0);
    m.insert("dried stabilized egg white", 107.0);
    m.insert("dried whole egg (without free-flow agent added)", 85.0);
    m.insert("egg, white, dried", 107.0);
    m.insert("egg, whole, dried", 85.0);
    m.insert("egg, yolk, dried", 67.0);
    m.insert("figs, dried, uncooked", 149.0);
    m.insert("granulated sugar", 200.0);
    m.insert(
        "grapefruit juice, white, canned or bottled, unsweetened",
        257.0,
    );
    m.insert("grapefruit juice, white, shelf stable, ocean spray", 222.0);
    m.insert(
        "grapefruit juice, white, shelf stable, signature kitchen",
        270.0,
    );
    m.insert("heavy cream", 238.0);
    m.insert("honey", 340.0);
    m.insert("hummus, commercial", 271.2);
    m.insert("hummus, other", 278.4);
    m.insert("hummus, tribe classic", 278.4);
    m.insert("kale, fresh, unprepared", 17.4);
    m.insert("kale, frozen, as purchased", 122.0);
    m.insert("kale, frozen, cooked, boiled, drained, without salt", 118.0);
    m.insert("kale, raw", 20.6);
    m.insert("liquid egg white (without whipping agents)", 243.0);
    m.insert("liquid egg yolk (plain, no salt or sugar)", 243.0);
    m.insert("liquid whole egg (plain, no salt or sugar)", 243.0);
    m.insert("maple syrup", 315.0);
    m.insert("melons, cantaloupe, raw", 158.0);
    m.insert("milk", 245.0);
    m.insert("milk, 1% (wave 22e)", 238.0);
    m.insert("milk, 2% (wave 22e)", 223.0);
    m.insert(
        "milk, nonfat, fluid, with added vitamin a and vitamin d (fat free or skim)",
        229.0,
    );
    m.insert("milk, skim (wave 22e)", 222.0);
    m.insert("milk, whole (wave 22e)", 235.5);
    m.insert("milk, whole, 3.25% milkfat, with added vitamin d", 229.0);
    m.insert("mustard, prepared, yellow", 249.0);
    m.insert("nectarines, raw", 143.0);
    m.insert("nectarines, walmart, ar1, nf0008uh", 143.0);
    m.insert("nuts, almonds, dry roasted, with salt added", 135.0);
    m.insert("oil, coconut", 185.6);
    m.insert("olive oil", 216.0);
    m.insert("oranges, raw, navels", 165.0);
    m.insert(
        "oranges, raw, navels (includes foods for usda's food distribution program)",
        165.0,
    );
    m.insert("peaches, yellow, raw", 154.0);
    m.insert("peanut butter", 258.0);
    m.insert("peanut butter, smooth style, with salt", 258.0);
    m.insert("pears, barlett, or/wa3, nfy0000kz", 150.5);
    m.insert("pears, raw, bartlett", 140.0);
    m.insert(
        "pears, raw, bartlett (includes foods for usda's food distribution program)",
        140.0,
    );
    m.insert("powdered sugar", 120.0);
    m.insert("rolled oats", 80.0);
    m.insert("salsa, tostitos chunky - medium", 259.0);
    m.insert("salt, essential everyday, iodized", 288.0);
    m.insert("salt, food club, iodized", 283.2);
    m.insert("salt, heb iodized", 283.2);
    m.insert("salt, hy vee, iodized", 297.6);
    m.insert("salt, laura lynn, iodized", 288.0);
    m.insert("salt, morton, iodized", 316.8);
    m.insert("salt, shop rite, iodized", 302.4);
    m.insert("salt, signature kitchens, iodized", 288.0);
    m.insert("salt, table, iodized", 292.8);
    m.insert("sauce, salsa, ready-to-serve", 285.6);
    m.insert(
        "sausage, pork, chorizo, link or ground, cooked, pan-fried",
        185.0,
    );
    m.insert(
        "seeds, sunflower seed kernels, dry roasted, with salt added",
        127.0,
    );
    m.insert("sour cream", 242.0);
    m.insert("sugars, granulated", 188.0);
    m.insert("sunflower seeds, dry roasted, salted, planters", 126.0);
    m.insert("tomatoes, canned, diced, hunts", 252.0);
    m.insert("tomatoes, canned, red, ripe, diced", 245.0);
    m.insert("tomatoes, grape", 155.0);
    m.insert("tomatoes, grape, raw", 152.0);
    m.insert("vegetable oil", 218.0);
    m.insert("whole wheat flour", 120.0);

    m
});

/// Aliases mapping common ingredient names to canonical names.
pub static INGREDIENT_ALIASES: LazyLock<HashMap<&'static str, &'static str>> =
    LazyLock::new(|| {
        let mut m = HashMap::new();

        m.insert("ap flour", "all-purpose flour");
        m.insert("canola oil", "vegetable oil");
        m.insert("caster sugar", "granulated sugar");
        m.insert("confectioners sugar", "powdered sugar");
        m.insert("confectioners' sugar", "powdered sugar");
        m.insert("corn starch", "cornstarch");
        m.insert("dark brown sugar", "brown sugar");
        m.insert("double cream", "heavy cream");
        m.insert("dutch process cocoa powder", "cocoa powder");
        m.insert("extra virgin olive oil", "olive oil");
        m.insert("extra-virgin olive oil", "olive oil");
        m.insert("flour", "all-purpose flour");
        m.insert("heavy whipping cream", "heavy cream");
        m.insert("icing sugar", "powdered sugar");
        m.insert("light brown sugar", "brown sugar");
        m.insert("natural cocoa powder", "cocoa powder");
        m.insert("oats", "rolled oats");
        m.insert("oil", "vegetable oil");
        m.insert("old fashioned oats", "rolled oats");
        m.insert("old-fashioned oats", "rolled oats");
        m.insert("packed brown sugar", "brown sugar");
        m.insert("plain flour", "all-purpose flour");
        m.insert("pure maple syrup", "maple syrup");
        m.insert("salted butter", "butter");
        m.insert("sugar", "granulated sugar");
        m.insert("unsalted butter", "butter");
        m.insert("unsweetened cocoa powder", "cocoa powder");
        m.insert("whipping cream", "heavy cream");
        m.insert("white flour", "all-purpose flour");
        m.insert("white sugar", "granulated sugar");
        m.insert("whole milk", "milk");

        m
    });

/// Common modifiers to strip from ingredient names before matching.
const MODIFIERS_TO_STRIP: &[&str] = &[
    // Temperature/state modifiers (prefix)
    "room temperature ",
    "cold ",
    "warm ",
    "melted ",
    "softened ",
    // Preparation modifiers (suffix)
    ", softened",
    ", melted",
    ", cold",
    ", at room temperature",
    ", room temperature",
    ", chilled",
    ", sifted",
];

/// Convert a volume unit to its equivalent in cups.
pub fn volume_to_cups(amount: f64, unit: &str) -> Option<f64> {
    match unit {
        "cup" => Some(amount),
        "tbsp" => Some(amount * CUPS_PER_TBSP),
        "tsp" => Some(amount * CUPS_PER_TSP),
        "fl oz" => Some(amount * CUPS_PER_FL_OZ),
        "pint" => Some(amount * CUPS_PER_PINT),
        "quart" => Some(amount * CUPS_PER_QUART),
        "gallon" => Some(amount * CUPS_PER_GALLON),
        "ml" => Some(amount * CUPS_PER_ML),
        "l" => Some(amount * CUPS_PER_L),
        _ => None,
    }
}

/// Check if a unit is a volume unit we can convert.
pub fn is_volume_unit(unit: Option<&str>) -> bool {
    matches!(
        unit,
        Some("cup")
            | Some("tbsp")
            | Some("tsp")
            | Some("fl oz")
            | Some("pint")
            | Some("quart")
            | Some("gallon")
            | Some("ml")
            | Some("l")
    )
}

/// Find the density (grams per cup) for an ingredient name.
///
/// Tries:
/// 1. Direct lookup in DENSITY_DATA
/// 2. Lookup via INGREDIENT_ALIASES
/// 3. After stripping common modifiers, retry both lookups
pub fn find_density(ingredient_item: &str) -> Option<f64> {
    let normalized = normalize_ingredient_name(ingredient_item);

    // Direct lookup
    if let Some(&density) = DENSITY_DATA.get(normalized.as_str()) {
        return Some(density);
    }

    // Alias lookup
    if let Some(&canonical) = INGREDIENT_ALIASES.get(normalized.as_str()) {
        if let Some(&density) = DENSITY_DATA.get(canonical) {
            return Some(density);
        }
    }

    // Try with modifiers stripped
    let stripped = strip_modifiers(&normalized);
    if stripped != normalized {
        if let Some(&density) = DENSITY_DATA.get(stripped.as_str()) {
            return Some(density);
        }
        if let Some(&canonical) = INGREDIENT_ALIASES.get(stripped.as_str()) {
            if let Some(&density) = DENSITY_DATA.get(canonical) {
                return Some(density);
            }
        }
    }

    None
}

/// Normalize ingredient name for matching.
fn normalize_ingredient_name(s: &str) -> String {
    s.to_lowercase().trim().to_string()
}

/// Strip common modifiers from ingredient name.
fn strip_modifiers(s: &str) -> String {
    let mut result = s.to_string();
    for modifier in MODIFIERS_TO_STRIP {
        if let Some(stripped) = result.strip_prefix(modifier) {
            result = stripped.to_string();
        }
        if let Some(stripped) = result.strip_suffix(modifier) {
            result = stripped.to_string();
        }
    }
    result
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_find_density_direct() {
        // These should find densities (exact names from USDA)
        assert!(find_density("cheese, cheddar").is_some());
    }

    #[test]
    fn test_find_density_alias() {
        // Common aliases should work
        assert!(find_density("flour").is_some());
        assert!(find_density("sugar").is_some());
        assert!(find_density("butter").is_some());
    }

    #[test]
    fn test_find_density_with_modifiers() {
        assert!(find_density("softened butter").is_some());
        assert!(find_density("melted butter").is_some());
    }

    #[test]
    fn test_find_density_case_insensitive() {
        assert!(find_density("FLOUR").is_some());
        assert!(find_density("Butter").is_some());
    }

    #[test]
    fn test_find_density_unknown() {
        assert_eq!(find_density("unicorn tears"), None);
        assert_eq!(find_density("mystery powder"), None);
    }

    #[test]
    fn test_volume_to_cups() {
        assert_eq!(volume_to_cups(1.0, "cup"), Some(1.0));
        assert_eq!(volume_to_cups(16.0, "tbsp"), Some(1.0));
        assert_eq!(volume_to_cups(48.0, "tsp"), Some(1.0));
        assert_eq!(volume_to_cups(8.0, "fl oz"), Some(1.0));
        assert_eq!(volume_to_cups(0.5, "pint"), Some(1.0));
    }

    #[test]
    fn test_is_volume_unit() {
        assert!(is_volume_unit(Some("cup")));
        assert!(is_volume_unit(Some("tbsp")));
        assert!(is_volume_unit(Some("tsp")));
        assert!(!is_volume_unit(Some("oz")));
        assert!(!is_volume_unit(Some("lb")));
        assert!(!is_volume_unit(Some("g")));
        assert!(!is_volume_unit(None));
    }
}
