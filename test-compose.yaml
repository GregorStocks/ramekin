version: "0.5"
extends: compose/base.yaml

log_location: ./logs/test.log

processes:
  rust-tests:
    command: |
      echo "[TIMING] rust-tests starting at $(date +%H:%M:%S)"
      START=$(date +%s)
      cargo test -q --manifest-path server/Cargo.toml && cargo test -q --manifest-path cli/Cargo.toml
      echo "[TIMING] rust-tests completed in $(($(date +%s) - START))s"
    availability:
      restart: "no"

  fixture:
    command: python3 -m http.server ${FIXTURE_PORT}
    working_dir: ./tests/scrape_fixtures
    readiness_probe:
      http_get:
        host: localhost
        port: ${FIXTURE_PORT}
        path: /

  mock-openrouter:
    command: python3 tests/mock_openrouter.py ${MOCK_OPENROUTER_PORT}
    readiness_probe:
      http_get:
        host: localhost
        port: ${MOCK_OPENROUTER_PORT}
        path: /

  server:
    working_dir: ./server
    environment:
      - SCRAPE_ALLOWED_HOSTS=localhost:${FIXTURE_PORT}
      - OPENROUTER_API_KEY=test-api-key
      - RAMEKIN_AI_BASE_URL=http://localhost:${MOCK_OPENROUTER_PORT}/v1
    depends_on:
      fixture:
        condition: process_healthy
      mock-openrouter:
        condition: process_healthy

  cli-build:
    command: |
      echo "[TIMING] cli-build starting at $(date +%H:%M:%S)"
      START=$(date +%s)
      cargo build -q
      echo "[TIMING] cli-build completed in $(($(date +%s) - START))s"
    working_dir: ./cli
    availability:
      restart: "no"
    depends_on:
      server:
        condition: process_healthy

  api-tests:
    command: |
      echo "[TIMING] api-tests starting at $(date +%H:%M:%S)"
      START=$(date +%s)
      pytest tests -v --ignore=tests/ui
      EXIT_CODE=$?
      echo "[TIMING] api-tests completed in $(($(date +%s) - START))s"
      exit $EXIT_CODE
    environment:
      - FIXTURE_BASE_URL=http://localhost:${FIXTURE_PORT}
      - API_BASE_URL=http://localhost:${PORT}
      - CLI_PATH=./cli/target/debug/ramekin-cli
    availability:
      restart: "no"
      exit_on_end: true
    depends_on:
      cli-build:
        condition: process_completed_successfully
      rust-tests:
        condition: process_completed_successfully
