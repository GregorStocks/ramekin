version: "0.5"

log_location: ./logs/test.log
log_configuration:
  disable_json: true
  no_color: true
  add_timestamp: true
  flush_each_line: true

processes:
  fixture:
    command: python3 -m http.server ${FIXTURE_PORT}
    working_dir: ./tests/scrape_fixtures
    readiness_probe:
      http_get:
        host: localhost
        port: ${FIXTURE_PORT}
        path: /

  server:
    command: cargo run --release -q
    working_dir: ./server
    environment:
      - SCRAPE_ALLOWED_HOSTS=localhost:${FIXTURE_PORT}
    readiness_probe:
      http_get:
        host: localhost
        port: ${PORT}
        path: /api/test/unauthed-ping
    depends_on:
      fixture:
        condition: process_healthy

  cli-build:
    command: cargo build -q
    working_dir: ./cli
    availability:
      restart: "no"
    depends_on:
      server:
        condition: process_healthy

  api-tests:
    command: pytest tests -v --ignore=tests/ui
    environment:
      - FIXTURE_BASE_URL=http://localhost:${FIXTURE_PORT}
      - API_BASE_URL=http://localhost:${PORT}
      - CLI_PATH=./cli/target/debug/ramekin-cli
    availability:
      restart: "no"
      exit_on_end: true
    depends_on:
      cli-build:
        condition: process_completed_successfully
