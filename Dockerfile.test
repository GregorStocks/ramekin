FROM rust:latest

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libpq-dev \
    postgresql-client \
    python3 \
    openjdk-21-jre-headless \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv from official image
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /usr/local/bin/

# Install diesel CLI
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/usr/local/cargo/git \
    cargo install diesel_cli --no-default-features --features postgres

# Make cargo directories writable by non-root users
RUN chmod -R 777 /usr/local/cargo

# Install openapi-generator-cli
RUN curl -L https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.10.0/openapi-generator-cli-7.10.0.jar \
    -o /usr/local/bin/openapi-generator-cli.jar && \
    echo '#!/bin/bash\njava -jar /usr/local/bin/openapi-generator-cli.jar "$@"' > /usr/local/bin/openapi-generator-cli && \
    chmod +x /usr/local/bin/openapi-generator-cli

WORKDIR /app

# Create a virtual environment for Python test dependencies
RUN uv venv /opt/venv
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install Python test dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install urllib3 python-dateutil pydantic typing-extensions pytest requests

# Make everything writable by non-root users
RUN mkdir -p /app/server/target /app/cli/target && chmod -R 777 /app
RUN chmod -R 777 /opt/venv

# Copy test runner script
COPY --chmod=755 scripts/run-tests.sh /usr/local/bin/run-tests.sh

# Just keep the container alive - tests are run via exec
# Use bash to properly reap zombie processes
CMD ["bash", "-c", "trap 'wait' SIGCHLD; while true; do sleep 1; done"]
