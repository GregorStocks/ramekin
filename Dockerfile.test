FROM rust:latest

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libpq-dev \
    postgresql-client \
    python3 \
    python3-pip \
    python3-venv \
    openjdk-21-jre-headless \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install diesel CLI
RUN cargo install diesel_cli --no-default-features --features postgres

# Make cargo directories writable by non-root users
RUN chmod -R 777 /usr/local/cargo

# Install openapi-generator-cli
RUN curl -L https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.10.0/openapi-generator-cli-7.10.0.jar \
    -o /usr/local/bin/openapi-generator-cli.jar && \
    echo '#!/bin/bash\njava -jar /usr/local/bin/openapi-generator-cli.jar "$@"' > /usr/local/bin/openapi-generator-cli && \
    chmod +x /usr/local/bin/openapi-generator-cli

WORKDIR /app

# Create a virtual environment
RUN python3 -m venv /app/venv
ENV PATH="/app/venv/bin:$PATH"

# Install Python dependencies
RUN /app/venv/bin/pip install urllib3 python-dateutil pydantic typing-extensions pytest requests

# Make everything writable by non-root users
RUN mkdir -p /app/server/target /app/cli/target && chmod -R 777 /app

# The source and tests will be mounted as volumes
